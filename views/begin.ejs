<!DOCTYPE html>
<html>
  <head>
    <title>Share Escrow Bot</title>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <!--<script src="/js/main.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    <script>
      let txid;
      let psid;
      function showPaymentsOrForm(thread_context) {
        console.log('showPaymentsOrForm called');
        fetch("https://hospitable-quarter.glitch.me/checkUser", {
          body: JSON.stringify({psid : thread_context.psid}), // must match 'Content-Type' header
          cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
          credentials: 'same-origin', // include, same-origin, *omit
          headers: {
            'user-agent': 'Mozilla/4.0 MDN Example',
            'content-type': 'application/json'
          },
          method: 'POST', // *GET, POST, PUT, DELETE, etc.
          mode: 'cors', // no-cors, cors, *same-origin
          redirect: 'follow', // *manual, follow, error
          referrer: 'no-referrer', // *client, no-referrer
        })
        .then((response) => function(response) {return response.json();})
        .then((data) => {
          console.log('checked user great success');
          //if (data.user_present){
            $("#maindiv").show();
           $("#payments").show();
        })
        }
      
      function showError(err) {
         console.log(err);
         $("#errorMessage").show();
      }
      
      function sendToStripe() {
        MessengerExtensions.getContext("419937085114571", function (thread_context) {
         let psid = thread_context.psid;
         console.log("PSID" + psid);
         let url = "https://hospitable-quarter.glitch.me/authorize?redirect=https://hospitable-quarter.glitch.me/receiveLogin/begin"
         url = url.concat("&psid=").concat(psid);
         console.log(url);
         window.location.replace(url);
        },
        function (err) {
          console.log(err);
        });
                                
      }
    
    </script>
  </head>
  <body>
    <div id="content"></div>
    
    
    <script>
      (function(){
        var oldLog = console.log;
        console.log = function (message) {
          // document.write('message: ' + message);
          // document.write(typeof(message));
          // message = String(message);
          fetch('https://hospitable-quarter.glitch.me/log', {
            body: JSON.stringify({text: message}), // must match 'Content-Type' header
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, same-origin, *omit
            headers: {
              'user-agent': 'Mozilla/4.0 MDN Example',
              'content-type': 'application/json'
            },
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, cors, *same-origin
            redirect: 'follow', // *manual, follow, error
            referrer: 'no-referrer', // *client, no-referrer
          })
          .then(function(response) {return response.json()}) // parses response to JSON
          oldLog.apply(console, arguments);
        };
      })();
      console.log('in script');
      function dosomething () {
        console.log('dosomething called');
        let button = document.getElementById('submitbutton');
        button.disabled = true; 
        button.value = "Loading...";
        
        let price = document.getElementById('number').value;
        let description = document.getElementById('description').value;
        let roles = document.getElementsByName('role');
        let role_string = $("input[name=user_role]:checked").val();
        console.log("role: " + role_string);
        // assert role string not empty
        let title_string = '';
        let buyer = role_string !== 'seller';
        /*
        let data = {
          sender_id: 'string',
          group_id: 'string',
          price: 'number',
          sender_is_buyer: 'true|false',
          item_description: 'string',            
        };*/
        MessengerExtensions.getContext("419937085114571",
          function success(thread_context) {
            console.log('got context');
            console.log(thread_context.type);
            let data = {
              sender_id: thread_context.psid,
              group_id: thread_context.tid,
              price: price,
              sender_is_buyer: buyer,
              item_description: description,
            };
            function ask_profile(psid) {
              MessengerExtensions.getGrantedPermissions(function (permissions_response) {
                if (permissions_response.permission.indexOf('user_profile') > -1) {
                  // return getName();
                }
                else {
                  MessengerExtensions.askPermission(
                    function (permission_response) {
                      if (permission_response.permissions.indexOf('user_profile') > -1) {
                        // return getName();
                      }
                      else {
                        console.log('permission denied');
                      }
                    }, function(errorCode, errorMessage) {
                      console.log('user_profile permission denied');
                    },
                    'user_profile'
                  );
                }
              }, function () {
                console.log('error getting granted permissions');
              });
            }
            function ask_messaging(psid) {
              console.log('ask_messaging called');
              MessengerExtensions.getGrantedPermissions(function (permissions_response) {
                if (permissions_response.permission.indexOf('user_messaging') > -1) {
                  // return getName();
                }
                else {
                  MessengerExtensions.askPermission(
                    function (permission_response) {
                      if (permission_response.permissions.indexOf('user_messaging') > -1) {
                        // return getName();
                      }
                      else {
                        console.log('permission denied');
                      }
                    }, function(errorCode, errorMessage) {
                      console.log('user_messaging permission denied');
                    },
                    'user_messaging'
                  );
                }
              }, function () {
                console.log('error getting granted permissions');
              });
            }
            console.log()
            if (!buyer){
              ask_messaging(thread_context.psid);
            }
            ask_profile(thread_context.psid);
            console.log(data);
            fetch('https://hospitable-quarter.glitch.me/submit_transaction', {
              body: JSON.stringify(data), // must match 'Content-Type' header
              cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
              credentials: 'same-origin', // include, same-origin, *omit
              headers: {
                'user-agent': 'Mozilla/4.0 MDN Example',
                'content-type': 'application/json'
              },
              method: 'POST', // *GET, POST, PUT, DELETE, etc.
              mode: 'cors', // no-cors, cors, *same-origin
              redirect: 'follow', // *manual, follow, error
              referrer: 'no-referrer', // *client, no-referrer
            }).then((response) => {
              if (!response.ok) throw Error(response.statusText);
              return response.json();
            }).then((resData) => {
              data.txid = resData.txid;
              data.first_name = resData.first_name;
              data.last_name = resData.last_name;
              console.log("Sending template...");
              send_template(data);
            }).catch(error => console.log(error));
            
          },
          function error(err) {
            console.log("Error on get context");
          }
        );
        
        function send_template(data) {
          console.log('send_template called');
          let url = "https://hospitable-quarter.glitch.me/start_transaction?txid=".concat(data.txid);
          console.log(url);
          let title = '';
          if (data.sender_is_buyer) {
            title = `${data.first_name} ${data.last_name} wants to buy ${data.item_description} from you for $${data.price}`;
          }
          else {
            title = `${data.first_name} ${data.last_name} wants to sell you ${data.item_description} for $${data.price}`;
          }
          console.log(title);
          let message = {
            "attachment":{
              "type":"template",
              "payload":{
                "template_type": 'generic',
                "elements": [{
                  "title": title,
                  "image_url": "https://ivycoach.com/content/uploads/2011/07/University-Of-Michigan-Admissions-Stats.jpg",
                  "subtitle": "E-scrow bot is a safe way to buy and sell items on Facebook Marketplace",
                  "default_action":{
                    "messenger_extensions": true,
                    "type":"web_url",
                    "url": url,
                    "webview_height_ratio":"tall",
                  },
                  "buttons":[{
                    "messenger_extensions": true,
                    "type":"web_url",
                    "url": url,
                    "webview_height_ratio":"compact",
                    "title":"Accept or Decline"
                  }]
                }]
              }
            }
          };
          
          /*
          console.log(message);
          console.log(message.attachment.payload);
          console.log(message.attachment.payload.elements);
          console.log(message.attachment.payload.elements[0].default_action);
          console.log(message.attachment.payload.elements[0].buttons);*/
          
          console.log('Starting share flow');
          MessengerExtensions.beginShareFlow(function(share_response) {
            // post json about transaction

            // MessengerExtensions.requestCloseBrowser(null, null);
            // User dismissed without error, but did they share the message?
            console.log('shareflow');
            console.log(`share_response.is_sent = ${share_response.is_sent}`);
            if(share_response.is_sent === true){ 
              // User shared. We're done here!
              console.log('success');
              MessengerExtensions.requestCloseBrowser(null, null);
            }
            else{
              // User canceled their share! 
              // try again?
              console.log('failed');
            }
          }, 
          function(errorCode, errorMessage) {      
            // An error occurred in the process
            console.log('shareflow error');
            console.log(errorCode);
            console.log(errorMessage);
          },
          message,
          "current_thread");
        }
      }
        
          
      window.extAsyncInit = function() {
        // the Messenger Extensions JS SDK is done loading 
        // document.write('about to load buttonasdf');
        // window.loadButton();
        // document.write('making button visible');
        console.log('extAsyncInit called');
        MessengerExtensions.getContext("419937085114571", showPaymentsOrForm, showError);
        console.log('messenger extensions js sdk loaded');
        
      };
      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.com/en_US/messenger.Extensions.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'Messenger'));
    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <div id="maindiv" style="display:none" >
      <div class="container">
        <h2 style="color:#3B5998;">
        Transaction Information
        </h2>
        <div class="form-group">
          <span>Item name:</span><br>
          <input id="description" type="text"><br>
        </div>
        <div class="form-group">
          <span>Price:</span><br>
          <input id="number" type="number"><br>
        </div>
        
        <div class="form-group">
          <span>I am the:</span><br>
          <div class="radio">
            <label><input type="radio" name="user_role" value="buyer"> Buyer</label>
          </div>
          <div class="radio">
            <label><input type="radio" name="user_role" value="seller"> Seller <br></label>
          </div>
        </div>
        <button id="submitbutton" class="btn btn-default" onclick="dosomething()">
          Submit
        </button><br><br>
      </div>
    </div>
    <div id="payments" style="display:none">
      <h2>
        Connect With Stripe
      </h2>
      <p>
        It looks like we don't know your payment information. For us to be able to complete your transaction, you must authorize us to use your Stripe account.
      </p>
      <a href="javscript:void(0);" onclick="sendToStripe()">
          <button id="paymentBtn" class="btn btn-primary">
            Pay with Stripe 
          </button>
      </a>
    </div>
    <div id="errorMessage" style="display:none;">
      <p>
        Sorry, we had encountered an issue with our server. Please try again later or contact eecs497fbms@umich.edu
      </p>
    </div>
  </body>
</html>