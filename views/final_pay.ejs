
<html>
  <head>
   <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
  </head>
  <body>
    <script>var txid = <%- JSON.stringify(txid) %>;</script>
    <script>var link = <%- JSON.stringify(link) %>;</script>
    <script> 
      var psid;
      var close;
      (function(){
        var oldLog = console.log;
        console.log = function (message) {
          // document.write('message: ' + message);
          // document.write(typeof(message));
          // message = String(message);
          return fetch('https://hospitable-quarter.glitch.me/log', {
            body: JSON.stringify({text: message}), // must match 'Content-Type' header
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, same-origin, *omit
            headers: {
              'user-agent': 'Mozilla/4.0 MDN Example',
              'content-type': 'application/json'
            },
            method: 'POST', // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, cors, *same-origin
            redirect: 'follow', // *manual, follow, error
            referrer: 'no-referrer', // *client, no-referrer
          })
          .then(function(response) {return response.json()}) // parses response to JSON
          oldLog.apply(console, arguments);
        };
      })();
      
      function SubForm(){
        console.log('subform called');
        link = link.concat(psid);
        console.log("link is: " + link);
        $.ajax({
          url:link,
          type:'post',
          data:$('#chargeForm').serialize(),
          success:function(){
            console.log("Closin the browser");
            MessengerExtensions.requestCloseBrowser(null, null);
          }
        });
      }
      
      function show(psid) {
          console.log("Showing");
          let url = 'https://hospitable-quarter.glitch.me/transaction_info?txid=' + txid;
          fetch(url, { credentials: 'same-origin' })
          .then((response) => {
            if (!response.ok) throw Error(response.statusText);
            return response.json();
          })
          .then((data) => {
            console.log(data);
            console.log(data.itemLink);
            if (data.transaction.itemLink === null) {
               $("#seller_upload").show();
            }
            else {
              if (data.transaction.seller === psid) {
                 if (false && data.transaction.seller_paid === 1) {
                   $("#wait").show();
                 }
                 else {
                   $("#payNow").show();
                   $("#seller_pay").show();
                 }
              }
              else {
                if (false && data.transaction.buyer_paid === 1) {
                   $("#wait").show(); 
                }
                else {
                  $("#payNow").show();
                  $("#buyer_pay").show();
                }
              }
            }
          });
      }
      
      function sendText (message) {
        let req = 'https://hospitable-quarter.glitch.me/send_buyer_message';
        let body = {
          psid: user,
          txid: txid,
          message: message
        };
        fetch(req, {
          body: JSON.stringify(body), // must match 'Content-Type' header
          cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
          credentials: 'same-origin', // include, same-origin, *omit
          headers: {
            'user-agent': 'Mozilla/4.0 MDN Example',
            'content-type': 'application/json'
          },
          method: 'POST', // *GET, POST, PUT, DELETE, etc.
          mode: 'cors', // no-cors, cors, *same-origin
          redirect: 'follow', // *manual, follow, error
          referrer: 'no-referrer', // *client, no-referrer
        });
      }
      
      window.extAsyncInit = function() {
        console.log("exit async init");
         console.log(MessengerExtensions);
         MessengerExtensions.getContext("419937085114571", function (thread_context) {
           console.log("got context");
           psid = thread_context.psid;
           show(psid);
        }, (err) => {console.log(err);});

      };
      
      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.com/en_US/messenger.Extensions.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'Messenger'));
  </script>


    <div id="wait" style="display:none;">
      <p>
        You have submitted your payment. The buyer will receive an approval message once all payments are received.
      </p>
      
    </div>

    
    <div id="seller_upload" style="display:none;">
      <p>
        Seller has not uploaded the file. Please revisit after the item is submitted.
      </p>
    </div>
    
    <div id="payNow" style="display:none;">
      <div id="buyer_pay" style="display:none;">
          <p>
            Please submit your payment for the item using the button below. We will charge your stripe account for the agreed upon price plus an insurance hold. BOTH parties will be charged
           this hold. This hold guarantees your security in this transaction. In the case of a scam, the holds will be used to reimburse you for damages.
            <br>
            We will send you a message with the item for your approval once we have received your payment.
          </p>  
       </div>
       <div id="seller_pay" style="display:none;">
         <p>
           Please submit a payment for our insurance hold. This is a temporary hold that will be reimbursed upon transaction completion. BOTH parties will be charged
           this hold. This hold guarantees your security in this transaction. In the case of a scam, the holds will be used to reimburse you for damages.
           <br>
           We will send the buyer a message with the item for their approval once we have received your payment. On their approval, we will reimburse your hold.
         </p>
       </div>
        <form id="chargeForm" action="javascript:SubForm();" method="POST">
          <script
            src="https://checkout.stripe.com/checkout.js" class="stripe-button"
            data-key="pk_test_SfFEOJ30IbciexZavBVyQoZk"
            data-name="Escrow Bot"
            data-amount="<%= amount %>"
            data-description="Escrow Payment"
            data-zip-code="true"
            data-image="https://stripe.com/img/documentation/checkout/marketplace.png"
            data-locale="auto">
          </script>
        </form>
    </div>

</body>

</html>